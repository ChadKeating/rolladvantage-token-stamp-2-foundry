!function(){"use strict";const e={getSavePath:()=>game.settings.get(e.moduleNamespace,e.tokenPathSettingsKey),createDirectory:async()=>{let t=e.getSavePath();await FilePicker.createDirectory("data",t).catch(e=>{if(!(e.indexOf("file already exists")>0))throw console.error(e),new Error(e)})},onRemoveHelper:(e,t)=>{const a=e.parentNode;if(!a)throw new Error("The node must already be attached");const o=new MutationObserver(a=>{for(const n of a)for(const a of n.removedNodes)a===e&&(o.disconnect(),t())});o.observe(a,{childList:!0})},render:async(a,o)=>{var n=o.find('.tab[data-tab="image"]').find(".form-group .form-fields").first();n.append("<button type='button' id='ra-ts2-open-button' title='Create Token' tabindex='-1'><img src='https://rolladvantage.com/assets/images/logo/default.png' /></button>"),n.find("#ra-ts2-open-button").click(a=>{if(Object.keys(ui.windows).map(e=>ui.windows[e]).some(e=>e.options.classes.some(e=>"ra-ts2-wrapper"==e)))return;a.preventDefault();const n=new t;n.render(!0),n.exportInputBox=o.find("input.image"),e.onRemoveHelper(o[0],()=>{n.close()})})},moduleNamespace:"rolladvantage-token-stamp-2-foundry",tokenPathSettingsKey:"token-save-path"};class t extends Application{static get defaultOptions(){const e=super.defaultOptions;return e.template="/modules/rolladvantage-token-stamp-2-foundry/templates/wrapper-template.html",e.resizable=!1,e.width=841,e.height=678,e.classes=["ra-ts2-wrapper"],e.title="Token Stamp 2 - RollAdvantage.com",e}static createTokenFile(e,t){let a=atob(e.split(",")[1]),o=[];for(let e=0;e<a.length;e++)o.push(a.charCodeAt(e));let n=new Blob([new Uint8Array(o)],{type:"image/png"});return new File([n],t)}static async uploadToken(a,o){let n=t.createTokenFile(a,o);return await FilePicker.upload("data",e.getSavePath(),n,{})}async close(){return window.removeEventListener("message",this.boundCallback,!1),super.close()}foundryImportCallback(e){if("https://rolladvantage.com"===e.origin){if("sourceRegistered"===e.data.action&&(t.sourceRegistered=!0),"importToken"===e.data.action){let a=this,o=e.data.tokenName+"-"+Date.now().toString(36).slice(-6)+".png";t.uploadToken(e.data.stampData,o).then(e=>{a.exportInputBox[0].value=e.path,a.close()})}if("importTokenUrl"===e.data.action){let t=this;t.exportInputBox[0].value=e.data.tokenUrl,t.close()}}}activateListeners(e){super.activateListeners(e);let a=this;this.boundCallback=this.foundryImportCallback.bind(this),window.addEventListener("message",this.boundCallback,!1),t.sourceRegistered=!1;let o=document.getElementById("ra-ts2-iframe").contentWindow;!function e(){if(t.sourceRegistered){console.log("Token Stamp Connected - Source Registered");let e=new FilePicker;o.postMessage({action:"uploadPermission",uploadPermission:e.canUpload},"*")}else o.postMessage({action:"registerSource"},"*"),a._element.length>0&&(console.log("Waiting for Token Stamp"),setTimeout(e,500))}()}}Hooks.on("ready",()=>{game.settings.register(e.moduleNamespace,e.tokenPathSettingsKey,{name:"Token Stamp 2 Save Path",hint:"The path tokens are saved to when imported to Foundry.",scope:"world",config:!0,type:String,default:"worlds/"+(game.world.name||game.world.id)+"/rolladvantage",onChange:t=>e.createDirectory()}),Hooks.on("renderTokenConfig",e.render),e.createDirectory()})}();
//# sourceMappingURL=rolladvantage-token-stamp-2-foundry.js.map
