!function(){"use strict";const e={getSavePath:()=>"worlds/"+game.world.name+"/rolladvantage",createDirectory:async()=>{var t=e.getSavePath(),o=await FilePicker.browse("data",t);console.dir(o),null!=o&&o.target==t||FilePicker.createDirectory("data",t)},onRemoveHelper:(e,t)=>{const o=e.parentNode;if(!o)throw new Error("The node must already be attached");const a=new MutationObserver(o=>{for(const n of o)for(const o of n.removedNodes)o===e&&(a.disconnect(),t())});a.observe(o,{childList:!0})},render:async(o,a)=>{var n=a.find('.tab[data-tab="image"]').find(".form-group .form-fields").first();n.append("<button type='button' id='ra-ts2-open-button' title='Create Token' tabindex='-1'><img src='https://rolladvantage.com/assets/images/logo/default.png' /></button>"),n.find("#ra-ts2-open-button").click(o=>{if(Object.keys(ui.windows).map(e=>ui.windows[e]).some(e=>e.options.classes.some(e=>"ra-ts2-wrapper"==e)))return;o.preventDefault();const n=new t;n.render(!0),n.exportInputBox=a.find("input.image"),e.onRemoveHelper(a[0],()=>{n.close()})})}};class t extends Application{static get defaultOptions(){const e=super.defaultOptions;return e.template="/modules/rolladvantage-token-stamp-2-foundry/templates/wrapper-template.html",e.resizable=!1,e.width=841,e.height=678,e.classes=["ra-ts2-wrapper"],e.title="Token Stamp 2 - RollAdvantage.com",e}static createTokenFile(e,t){let o=atob(e.split(",")[1]),a=[];for(let e=0;e<o.length;e++)a.push(o.charCodeAt(e));let n=new Blob([new Uint8Array(a)],{type:"image/png"});return new File([n],t)}static async uploadToken(o,a){let n=t.createTokenFile(o,a);return await FilePicker.upload("data",e.getSavePath(),n,{})}async close(){return window.removeEventListener("message",this.boundCallback,!1),super.close()}foundryImportCallback(e){if("https://rolladvantage.com"==e.origin){if("sourceRegistered"==e.data.action&&(t.sourceRegistered=!0),"importToken"==e.data.action){let o=this,a=Math.floor(Math.floor(1e8*(Date.now()/1e8-Math.floor(Date.now()/1e8)))/100);t.uploadToken(e.data.stampData,game.userId+"-"+a+".png").then(e=>{o.exportInputBox[0].value=e.path,o.close()})}if("importTokenUrl"==e.data.action){let t=this;t.exportInputBox[0].value=e.data.tokenUrl,t.close()}}}activateListeners(e){super.activateListeners(e);let o=this;this.boundCallback=this.foundryImportCallback.bind(this),window.addEventListener("message",this.boundCallback,!1),t.sourceRegistered=!1;let a=document.getElementById("ra-ts2-iframe").contentWindow;!function e(){if(t.sourceRegistered){console.log("Token Stamp Connected - Source Registered");let e=new FilePicker;a.postMessage({action:"uploadPermission",uploadPermission:e.canUpload},"*")}else a.postMessage({action:"registerSource"},"*"),o._element.length>0&&(console.log("Waiting for TS"),setTimeout(e,500))}()}}Hooks.on("ready",()=>{const t=`renderTokenConfig${"pf1"===game.system.id?"PF":""}`;Hooks.on(t,e.render),e.createDirectory()})}();
//# sourceMappingURL=rolladvantage-token-stamp-2-foundry.js.map
