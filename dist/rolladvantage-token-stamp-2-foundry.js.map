{"version":3,"file":"rolladvantage-token-stamp-2-foundry.js","sources":["../src/index.js"],"sourcesContent":["import { canvasReady, ready } from \"./hooks\";\r\n\r\n// Hooks.on(\"canvasReady\", canvasReady);\r\n// Hooks.on(\"ready\", ready);\r\n\r\nconst RollAdvantageTokenStamp2 = {\r\n\tgetSavePath: () => {\r\n\t\treturn \"worlds/\" + game.world.name + \"/rolladvantage\";\r\n\t},\r\n\tcreateDirectory: async () => {\r\n\t\tvar savePath = RollAdvantageTokenStamp2.getSavePath();\r\n\t\tvar dir = await FilePicker.browse(\"data\", savePath);\r\n\t\tconsole.dir(dir);\r\n\t\tif (dir == null || dir.target != savePath) {\r\n\t\t\tFilePicker.createDirectory(\"data\", savePath)\r\n\t\t}\r\n\t},\r\n\trender: async (config, html) => {\r\n\t\tvar subHtml = html.find('.tab[data-tab=\"image\"]').find(\".form-group .form-fields\").first();\r\n\t\tsubHtml.append(\"<button type='button' id='ra-ts2-open-button' title='Create Token' tabindex='-1'><img src='https://rolladvantage.com/assets/images/logo/default.png' /></button>\");\r\n\t\tsubHtml.find(\"#ra-ts2-open-button\").click(event => {\r\n\t\t\tevent.preventDefault()\r\n\t\t\tconst wrapper = new TokenStampWrapper();\r\n\t\t\twrapper.render(true);\r\n\t\t\twrapper.exportInputBox = html.find(\"input.image\");\r\n\t\t});\r\n\t}\r\n};\r\n\r\nclass TokenStampWrapper extends Application {\r\n\tstatic get defaultOptions() {\r\n\t\tconst options = super.defaultOptions;\r\n\t\toptions.template = \"/modules/rolladvantage-token-stamp-2-foundry/templates/wrapper-template.html\";\r\n\t\toptions.resizable = false;\r\n\t\toptions.width = 1216;\r\n\t\toptions.height = 650;\r\n\t\toptions.classes = [\"ts2-wrapper\"];\r\n\t\toptions.title = \"Token Stamp 2 - RollAdvantage.com\";\r\n\t\treturn options;\r\n\t}\r\n\r\n\tstatic createTokenFile(data, filename) {\r\n\t\tvar blobBin = atob(data.split(',')[1]);\r\n\t\tvar array = [];\r\n\t\tfor (var i = 0; i < blobBin.length; i++) {\r\n\t\t\tarray.push(blobBin.charCodeAt(i));\r\n\t\t}\r\n\t\tvar fileBlob = new Blob([new Uint8Array(array)], { type: 'image/png' });\r\n\t\treturn new File([fileBlob], filename);\r\n\t}\r\n\r\n\tstatic async uploadToken(data, filename) {\r\n\t\tvar file = TokenStampWrapper.createTokenFile(data, filename);\r\n\t\treturn await FilePicker.upload(\"data\", RollAdvantageTokenStamp2.getSavePath(), file, {});\r\n\t\t/*\r\n\t\t// Create the form data to post\r\n\t\tconst fd = new FormData();\r\n\t\tlet test = await data;\r\n\t\tfd.set(\"source\", 'data');\r\n\t\tfd.set(\"target\", RollAdvantageTokenStamp2.getSavePath());\r\n\t\tfd.set(\"upload\", test, filename);\r\n\r\n\t\t// Dispatch the request\r\n\t\tconst request = await fetch('/upload', { method: \"POST\", body: fd });\r\n\t\tif (request.status === 413) {\r\n\t\t\treturn ui.notifications.error(game.i18n.localize(\"FILES.ErrorTooLarge\"));\r\n\t\t} else if (request.status !== 200) {\r\n\t\t\treturn ui.notifications.error(game.i18n.localize(\"FILES.ErrorSomethingWrong\"));\r\n\t\t}\r\n\r\n\t\t// Retrieve the server response\r\n\t\tconst response = await request.json();\r\n\t\tif (response.error) {\r\n\t\t\tui.notifications.error(response.error);\r\n\t\t\treturn false;\r\n\t\t} else if (response.message) {\r\n\t\t\tif (/^(modules|systems)/.test(response.path)) {\r\n\t\t\t\tui.notifications.warn(game.i18n.localize(\"FILES.WarnUploadModules\"))\r\n\t\t\t}\r\n\t\t\tui.notifications.info(response.message);\r\n\t\t}\r\n\t\treturn response;*/\r\n\t}\r\n\r\n\tasync close() {\r\n\t\twindow.removeEventListener(\"message\", this.foundryImportCallback.bind(this), false);\r\n\t\treturn super.close();\r\n\t}\r\n\r\n\tfoundryImportCallback(event) {\r\n\t\tif (event.origin != \"https://rolladvantage.com\") {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif(event.data.action == \"sourceRegistered\") {\r\n\t\t\tTokenStampWrapper.sourceRegistered = true;\r\n\t\t}\r\n\r\n\t\tif (event.data.action == \"importToken\") {\r\n\t\t\tvar that = this;\r\n\t\t\tvar timeStamp = Math.floor(Math.floor(((Date.now() / 100000000) - Math.floor(Date.now() / 100000000)) * 100000000) / 100);\r\n\t\t\tvar prom = TokenStampWrapper.uploadToken(event.data.stampData, game.userId + \"-\" + timeStamp + \".png\");\r\n\t\t\tprom.then(x => {\r\n\t\t\t\tthat.exportInputBox[0].value = x.path;\r\n\t\t\t\tthat.close();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\tsuper.activateListeners(html);\r\n\t\tvar that = this;\r\n\r\n\t\twindow.addEventListener(\"message\", this.foundryImportCallback.bind(this), false);\r\n\r\n\t\tTokenStampWrapper.sourceRegistered = false;\r\n\t\tvar iWindow = document.getElementById('ra-ts2-iframe').contentWindow;\r\n\t\tfunction waitForTokenStampLoaded() {\r\n\t\t\tif(TokenStampWrapper.sourceRegistered) {\r\n\t\t\t\tconsole.log(\"Source Registered\");\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tiWindow.postMessage({\r\n\t\t\t\taction: \"registerSource\"\r\n\t\t\t}, \"*\");\r\n\r\n\t\t\tif(that._element.length > 0) {\r\n\t\t\t\tconsole.log(\"Waiting for TS\");\r\n\t\t\t\tsetTimeout(waitForTokenStampLoaded, 500);\r\n\t\t\t}\r\n\t\t}\r\n\t\twaitForTokenStampLoaded();\r\n\t}\r\n\r\n\t/*\r\n\t Name \tType \tDescription\r\nbaseApplication \tstring\r\n\r\nA named \"base application\" which generates an additional hook\r\nwidth \tnumber\r\n\r\nThe default pixel width for the rendered HTML\r\nheight \tnumber\r\n\r\nThe default pixel height for the rendered HTML\r\ntop \tnumber\r\n\r\nThe default offset-top position for the rendered HTML\r\nleft \tnumber\r\n\r\nThe default offset-left position for the rendered HTML\r\npopOut \tboolean\r\n\r\nWhether to display the application as a pop-out container\r\nminimizable \tboolean\r\n\r\nWhether the rendered application can be minimized (popOut only)\r\nresizable \tboolean\r\n\r\nWhether the rendered application can be drag-resized (popOut only)\r\nid \tstring\r\n\r\nThe default CSS id to assign to the rendered HTML\r\nclasses \tArray.<string>\r\n\r\nAn array of CSS string classes to apply to the rendered HTML\r\ntitle \tstring\r\n\r\nA default window title string (popOut only)\r\ntemplate \tstring\r\n\r\nThe default HTML template path to render for this Application\r\nscrollY \tArray.<string>\r\n\r\nA list of unique CSS selectors which target containers that should have their vertical scroll positions preserved during a re-render.\r\n\t**/\r\n}\r\n\r\nHooks.on('ready', () => {\r\n\tconst renderTokenConfig = `renderTokenConfig${game.system.id === 'pf1' ? 'PF' : ''}`;\r\n\tHooks.on(renderTokenConfig, RollAdvantageTokenStamp2.render);\r\n\tRollAdvantageTokenStamp2.createDirectory();\r\n});"],"names":["RollAdvantageTokenStamp2","getSavePath","game","world","name","createDirectory","async","savePath","dir","FilePicker","browse","console","target","render","config","html","subHtml","find","first","append","click","event","preventDefault","wrapper","TokenStampWrapper","exportInputBox","Application","defaultOptions","options","super","template","resizable","width","height","classes","title","[object Object]","data","filename","blobBin","atob","split","array","i","length","push","charCodeAt","fileBlob","Blob","Uint8Array","type","File","file","createTokenFile","upload","window","removeEventListener","this","foundryImportCallback","bind","close","origin","action","sourceRegistered","that","timeStamp","Math","floor","Date","now","uploadToken","stampData","userId","then","x","value","path","activateListeners","addEventListener","iWindow","document","getElementById","contentWindow","waitForTokenStampLoaded","log","postMessage","_element","setTimeout","Hooks","on","renderTokenConfig","system","id"],"mappings":"yBAKA,MAAMA,EAA2B,CAChCC,YAAa,IACL,UAAYC,KAAKC,MAAMC,KAAO,iBAEtCC,gBAAiBC,UAChB,IAAIC,EAAWP,EAAyBC,cACpCO,QAAYC,WAAWC,OAAO,OAAQH,GAC1CI,QAAQH,IAAIA,GACD,MAAPA,GAAeA,EAAII,QAAUL,GAChCE,WAAWJ,gBAAgB,OAAQE,IAGrCM,OAAQP,MAAOQ,EAAQC,KACtB,IAAIC,EAAUD,EAAKE,KAAK,0BAA0BA,KAAK,4BAA4BC,QACnFF,EAAQG,OAAO,oKACfH,EAAQC,KAAK,uBAAuBG,MAAMC,IACzCA,EAAMC,iBACN,MAAMC,EAAU,IAAIC,EACpBD,EAAQV,QAAO,GACfU,EAAQE,eAAiBV,EAAKE,KAAK,mBAKtC,MAAMO,UAA0BE,YAC/BC,4BACC,MAAMC,EAAUC,MAAMF,eAOtB,OANAC,EAAQE,SAAW,+EACnBF,EAAQG,WAAY,EACpBH,EAAQI,MAAQ,KAChBJ,EAAQK,OAAS,IACjBL,EAAQM,QAAU,CAAC,eACnBN,EAAQO,MAAQ,oCACTP,EAGRQ,uBAAuBC,EAAMC,GAG5B,IAFA,IAAIC,EAAUC,KAAKH,EAAKI,MAAM,KAAK,IAC/BC,EAAQ,GACHC,EAAI,EAAGA,EAAIJ,EAAQK,OAAQD,IACnCD,EAAMG,KAAKN,EAAQO,WAAWH,IAE/B,IAAII,EAAW,IAAIC,KAAK,CAAC,IAAIC,WAAWP,IAAS,CAAEQ,KAAM,cACzD,OAAO,IAAIC,KAAK,CAACJ,GAAWT,GAG7BF,yBAAyBC,EAAMC,GAC9B,IAAIc,EAAO5B,EAAkB6B,gBAAgBhB,EAAMC,GACnD,aAAa7B,WAAW6C,OAAO,OAAQtD,EAAyBC,cAAemD,EAAM,IA+BtFhB,cAEC,OADAmB,OAAOC,oBAAoB,UAAWC,KAAKC,sBAAsBC,KAAKF,OAAO,GACtE5B,MAAM+B,QAGdxB,sBAAsBf,GACrB,GAAoB,6BAAhBA,EAAMwC,SAIc,oBAArBxC,EAAMgB,KAAKyB,SACbtC,EAAkBuC,kBAAmB,GAGb,eAArB1C,EAAMgB,KAAKyB,QAAyB,CACvC,IAAIE,EAAOP,KACPQ,EAAYC,KAAKC,MAAMD,KAAKC,MAAwE,KAAhEC,KAAKC,MAAQ,IAAaH,KAAKC,MAAMC,KAAKC,MAAQ,OAA2B,KAC1G7C,EAAkB8C,YAAYjD,EAAMgB,KAAKkC,UAAWrE,KAAKsE,OAAS,IAAMP,EAAY,QAC1FQ,KAAKC,IACTV,EAAKvC,eAAe,GAAGkD,MAAQD,EAAEE,KACjCZ,EAAKJ,WAKRxB,kBAAkBrB,GACjBc,MAAMgD,kBAAkB9D,GACxB,IAAIiD,EAAOP,KAEXF,OAAOuB,iBAAiB,UAAWrB,KAAKC,sBAAsBC,KAAKF,OAAO,GAE1EjC,EAAkBuC,kBAAmB,EACrC,IAAIgB,EAAUC,SAASC,eAAe,iBAAiBC,eACvD,SAASC,IACL3D,EAAkBuC,iBACpBpD,QAAQyE,IAAI,sBAIbL,EAAQM,YAAY,CACnBvB,OAAQ,kBACN,KAEAE,EAAKsB,SAAS1C,OAAS,IACzBjC,QAAQyE,IAAI,kBACZG,WAAWJ,EAAyB,OAGtCA,IA+CFK,MAAMC,GAAG,QAAS,KACjB,MAAMC,EAAoB,oBAAuC,QAAnBxF,KAAKyF,OAAOC,GAAe,KAAO,KAChFJ,MAAMC,GAAGC,EAAmB1F,EAAyBa,QACrDb,EAAyBK"}