{"version":3,"file":"rolladvantage-token-stamp-2-foundry.js","sources":["../src/index.js"],"sourcesContent":["const RollAdvantageTokenStamp2 = {\r\n\tgetSavePath: () => {\r\n\t\treturn \"worlds/\" + game.world.name + \"/rolladvantage\";\r\n\t},\r\n\tcreateDirectory: async () => {\r\n\t\tvar savePath = RollAdvantageTokenStamp2.getSavePath();\r\n\t\tvar dir = await FilePicker.browse(\"data\", savePath);\r\n\t\tconsole.dir(dir);\r\n\t\tif (dir == null || dir.target != savePath) {\r\n\t\t\tFilePicker.createDirectory(\"data\", savePath)\r\n\t\t}\r\n\t},\r\n\t//https://stackoverflow.com/questions/50391422/detect-that-given-element-has-been-removed-from-the-dom-without-sacrificing-perf\r\n\tonRemoveHelper: (element, callback) => {\r\n\t\tconst parent = element.parentNode;\r\n\t\tif (!parent) throw new Error(\"The node must already be attached\");\r\n\r\n\t\tconst obs = new MutationObserver(mutations => {\r\n\t\t\tfor (const mutation of mutations) {\r\n\t\t\t\tfor (const el of mutation.removedNodes) {\r\n\t\t\t\t\tif (el === element) {\r\n\t\t\t\t\t\tobs.disconnect();\r\n\t\t\t\t\t\tcallback();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\tobs.observe(parent, {\r\n\t\t\tchildList: true,\r\n\t\t});\r\n\t},\r\n\trender: async (config, html) => {\r\n\t\tvar subHtml = html.find('.tab[data-tab=\"image\"]').find(\".form-group .form-fields\").first();\r\n\t\tsubHtml.append(\"<button type='button' id='ra-ts2-open-button' title='Create Token' tabindex='-1'><img src='https://rolladvantage.com/assets/images/logo/default.png' /></button>\");\r\n\t\tsubHtml.find(\"#ra-ts2-open-button\").click(event => {\r\n\r\n\t\t\tlet isStampOpen = Object.keys(ui.windows)\r\n\t\t\t\t.map(key => ui.windows[key])\r\n\t\t\t\t.some(win => win.options.classes.some(x => x == \"ra-ts2-wrapper\"));\r\n\r\n\t\t\tif(isStampOpen)\r\n\t\t\t\treturn;\r\n\r\n\t\t\tevent.preventDefault()\r\n\t\t\tconst wrapper = new TokenStampWrapper();\r\n\t\t\twrapper.render(true);\r\n\t\t\twrapper.exportInputBox = html.find(\"input.image\");\r\n\r\n\t\t\tRollAdvantageTokenStamp2.onRemoveHelper(html[0], ()=>{\r\n\t\t\t\twrapper.close();\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n};\r\n\r\nclass TokenStampWrapper extends Application {\r\n\tstatic get defaultOptions() {\r\n\t\tconst options = super.defaultOptions;\r\n\t\toptions.template = \"/modules/rolladvantage-token-stamp-2-foundry/templates/wrapper-template.html\";\r\n\t\toptions.resizable = false;\r\n\t\toptions.width = 841;\r\n\t\toptions.height = 678;\r\n\t\toptions.classes = [\"ra-ts2-wrapper\"];\r\n\t\toptions.title = \"Token Stamp 2 - RollAdvantage.com\";\r\n\t\treturn options;\r\n\t}\r\n\r\n\tstatic createTokenFile(data, filename) {\r\n\t\tlet blobBin = atob(data.split(',')[1]);\r\n\t\tlet array = [];\r\n\t\tfor (let i = 0; i < blobBin.length; i++) {\r\n\t\t\tarray.push(blobBin.charCodeAt(i));\r\n\t\t}\r\n\t\tlet fileBlob = new Blob([new Uint8Array(array)], { type: 'image/png' });\r\n\t\treturn new File([fileBlob], filename);\r\n\t}\r\n\r\n\tstatic async uploadToken(data, filename) {\r\n\t\tlet file = TokenStampWrapper.createTokenFile(data, filename);\r\n\t\tlet uploadResponse = await FilePicker.upload(\"data\", RollAdvantageTokenStamp2.getSavePath(), file, {});\r\n\t\treturn uploadResponse;\r\n\t}\r\n\r\n\tasync close() {\r\n\t\twindow.removeEventListener(\"message\", this.boundCallback, false);\r\n\t\treturn super.close();\r\n\t}\r\n\r\n\tfoundryImportCallback(event) {\r\n\t\tif (event.origin != \"https://rolladvantage.com\") {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif(event.data.action == \"sourceRegistered\") {\r\n\t\t\tTokenStampWrapper.sourceRegistered = true;\r\n\r\n\t\t}\r\n\r\n\t\tif (event.data.action == \"importToken\") {\r\n\t\t\tlet that = this;\r\n\t\t\tlet timeStamp = Math.floor(Math.floor(((Date.now() / 100000000) - Math.floor(Date.now() / 100000000)) * 100000000) / 100);\r\n\t\t\tlet prom = TokenStampWrapper.uploadToken(event.data.stampData, game.userId + \"-\" + timeStamp + \".png\");\r\n\t\t\tprom\r\n\t\t\t.then(x => {\r\n\t\t\t\tthat.exportInputBox[0].value = x.path;\r\n\t\t\t\tthat.close();\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tif (event.data.action == \"importTokenUrl\") {\r\n\t\t\tlet that = this;\r\n\t\t\tthat.exportInputBox[0].value = event.data.tokenUrl;\r\n\t\t\tthat.close();\r\n\t\t}\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\tsuper.activateListeners(html);\r\n\t\tlet that = this;\r\n\r\n\t\tthis.boundCallback = this.foundryImportCallback.bind(this);\r\n\t\twindow.addEventListener(\"message\", this.boundCallback, false);\r\n\r\n\t\tTokenStampWrapper.sourceRegistered = false;\r\n\t\tlet iWindow = document.getElementById('ra-ts2-iframe').contentWindow;\r\n\t\tfunction waitForTokenStampLoaded() {\r\n\t\t\tif(TokenStampWrapper.sourceRegistered) {\r\n\t\t\t\tconsole.log(\"Token Stamp Connected - Source Registered\");\r\n\t\t\t\tlet fp = new FilePicker();\r\n\t\t\t\tiWindow.postMessage({\r\n\t\t\t\t\taction: \"uploadPermission\",\r\n\t\t\t\t\tuploadPermission: fp.canUpload\r\n\t\t\t\t}, \"*\");\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tiWindow.postMessage({\r\n\t\t\t\taction: \"registerSource\"\r\n\t\t\t}, \"*\");\r\n\r\n\t\t\tif(that._element.length > 0) {\r\n\t\t\t\tconsole.log(\"Waiting for TS\");\r\n\t\t\t\tsetTimeout(waitForTokenStampLoaded, 500);\r\n\t\t\t}\r\n\t\t}\r\n\t\twaitForTokenStampLoaded();\r\n\t}\r\n}\r\n\r\nHooks.on('ready', () => {\r\n\tconst renderTokenConfig = `renderTokenConfig${game.system.id === 'pf1' ? 'PF' : ''}`;\r\n\tHooks.on(renderTokenConfig, RollAdvantageTokenStamp2.render);\r\n\tRollAdvantageTokenStamp2.createDirectory();\r\n});"],"names":["RollAdvantageTokenStamp2","getSavePath","game","world","name","createDirectory","async","savePath","dir","FilePicker","browse","console","target","onRemoveHelper","element","callback","parent","parentNode","Error","obs","MutationObserver","mutations","mutation","el","removedNodes","disconnect","observe","childList","render","config","html","subHtml","find","first","append","click","event","Object","keys","ui","windows","map","key","some","win","options","classes","x","preventDefault","wrapper","TokenStampWrapper","exportInputBox","close","Application","defaultOptions","super","template","resizable","width","height","title","[object Object]","data","filename","blobBin","atob","split","array","i","length","push","charCodeAt","fileBlob","Blob","Uint8Array","type","File","file","createTokenFile","upload","window","removeEventListener","this","boundCallback","origin","action","sourceRegistered","that","timeStamp","Math","floor","Date","now","uploadToken","stampData","userId","then","value","path","tokenUrl","activateListeners","foundryImportCallback","bind","addEventListener","iWindow","document","getElementById","contentWindow","waitForTokenStampLoaded","log","fp","postMessage","uploadPermission","canUpload","_element","setTimeout","Hooks","on","renderTokenConfig","system","id"],"mappings":"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"}